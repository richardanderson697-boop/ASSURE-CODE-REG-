# ============================================================================
# alembic.ini - Alembic Configuration
# ============================================================================
# Place this in your project root

[alembic]
script_location = alembic
prepend_sys_path = .
sqlalchemy.url = postgresql+asyncpg://scraper:password@localhost:5432/compliance_scraper

[loggers]
keys = root,sqlalchemy,alembic

[handlers]
keys = console

[formatters]
keys = generic

[logger_root]
level = WARN
handlers = console

[logger_sqlalchemy]
level = WARN
handlers =
qualname = sqlalchemy.engine

[logger_alembic]
level = INFO
handlers =
qualname = alembic

[handler_console]
class = StreamHandler
args = (sys.stderr,)
level = NOTSET
formatter = generic

[formatter_generic]
format = %(levelname)-5.5s [%(name)s] %(message)s
datefmt = %H:%M:%S

# ============================================================================
# alembic/env.py - Alembic Environment Configuration
# ============================================================================

from logging.config import fileConfig
from sqlalchemy import pool
from sqlalchemy.engine import Connection
from sqlalchemy.ext.asyncio import async_engine_from_config
from alembic import context
import asyncio

# Import your models
from database import Base
import os

# this is the Alembic Config object
config = context.config

# Override sqlalchemy.url from environment variable if set
if os.getenv("DATABASE_URL"):
    database_url = os.getenv("DATABASE_URL")
    if database_url.startswith("postgres://"):
        database_url = database_url.replace("postgres://", "postgresql+asyncpg://", 1)
    config.set_main_option("sqlalchemy.url", database_url)

# Interpret the config file for Python logging
if config.config_file_name is not None:
    fileConfig(config.config_file_name)

target_metadata = Base.metadata

def run_migrations_offline() -> None:
    """Run migrations in 'offline' mode."""
    url = config.get_main_option("sqlalchemy.url")
    context.configure(
        url=url,
        target_metadata=target_metadata,
        literal_binds=True,
        dialect_opts={"paramstyle": "named"},
    )

    with context.begin_transaction():
        context.run_migrations()

def do_run_migrations(connection: Connection) -> None:
    context.configure(connection=connection, target_metadata=target_metadata)

    with context.begin_transaction():
        context.run_migrations()

async def run_async_migrations() -> None:
    """Run migrations in 'online' mode."""
    connectable = async_engine_from_config(
        config.get_section(config.config_ini_section, {}),
        prefix="sqlalchemy.",
        poolclass=pool.NullPool,
    )

    async with connectable.connect() as connection:
        await connection.run_sync(do_run_migrations)

    await connectable.dispose()

def run_migrations_online() -> None:
    """Run migrations in 'online' mode."""
    asyncio.run(run_async_migrations())

if context.is_offline_mode():
    run_migrations_offline()
else:
    run_migrations_online()

# ============================================================================
# setup_database.py - Initial Database Setup Script
# ============================================================================

#!/usr/bin/env python3
"""
Database setup script for Compliance Scraper
Run this to initialize your database and create first organization + API key
"""

import asyncio
import os
import sys
from dotenv import load_dotenv

load_dotenv()

# Set up path
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from database import (
    init_db, async_session_maker,
    Organization, User, ApiKey,
    SubscriptionStatus, UserRole,
    generate_api_key
)
import uuid

async def setup_database():
    """Initialize database and create test organization"""
    
    print("=" * 60)
    print("COMPLIANCE SCRAPER - DATABASE SETUP")
    print("=" * 60)
    
    # Initialize database tables
    print("\nðŸ“Š Creating database tables...")
    await init_db()
    print("âœ… Database tables created")
    
    # Create demo organization
    print("\nðŸ¢ Creating demo organization...")
    
    async with async_session_maker() as session:
        # Create organization
        org_id = f"org_{uuid.uuid4().hex[:16]}"
        org = Organization(
            id=org_id,
            name="Demo Financial Corp",
            subscription_status=SubscriptionStatus.ACTIVE,
            subscription_tier="enterprise",
            max_jobs_per_month=1000,
            max_api_calls_per_day=10000
        )
        session.add(org)
        await session.flush()
        
        # Create admin user
        user_id = str(uuid.uuid4())
        user = User(
            id=user_id,
            organization_id=org_id,
            auth0_user_id=f"auth0|{uuid.uuid4().hex}",
            email="admin@demo-financial.com",
            full_name="Demo Admin",
            role=UserRole.ADMIN,
            is_active=True
        )
        session.add(user)
        await session.flush()
        
        # Create API key
        full_key, key_hash, key_prefix = generate_api_key()
        
        api_key = ApiKey(
            id=str(uuid.uuid4()),
            organization_id=org_id,
            name="Demo API Key",
            key_hash=key_hash,
            key_prefix=key_prefix,
            is_active=True,
            rate_limit_per_minute=100
        )
        session.add(api_key)
        
        await session.commit()
        
        print(f"âœ… Organization created: {org.name}")
        print(f"âœ… Admin user created: {user.email}")
        print(f"âœ… API key generated")
        
        print("\n" + "=" * 60)
        print("SETUP COMPLETE!")
        print("=" * 60)
        
        print(f"\nðŸ“‹ Organization ID: {org_id}")
        print(f"ðŸ‘¤ User ID: {user_id}")
        print(f"ðŸ”‘ API Key: {full_key}")
        print(f"\nâš ï¸  SAVE THIS API KEY - it won't be shown again!")
        
        print("\nðŸ“ Example API Usage:")
        print(f"""
curl -X POST http://localhost:8000/api/v1/scrape \\
  -H "Authorization: Bearer {full_key}" \\
  -H "Content-Type: application/json" \\
  -d '{{
    "url": "https://www.sec.gov/rules/final/example.html",
    "jurisdiction": "US",
    "category": "finance"
  }}'
""")

async def create_organization_interactive():
    """Interactive organization creation"""
    
    print("\n" + "=" * 60)
    print("CREATE NEW ORGANIZATION")
    print("=" * 60)
    
    org_name = input("\nOrganization name: ")
    admin_email = input("Admin email: ")
    admin_name = input("Admin full name: ")
    
    tier = input("Subscription tier (professional/business/enterprise) [professional]: ") or "professional"
    
    async with async_session_maker() as session:
        # Create organization
        org_id = f"org_{uuid.uuid4().hex[:16]}"
        org = Organization(
            id=org_id,
            name=org_name,
            subscription_status=SubscriptionStatus.ACTIVE,
            subscription_tier=tier,
            max_jobs_per_month=100 if tier == "professional" else 500 if tier == "business" else 1000,
            max_api_calls_per_day=1000 if tier == "professional" else 5000 if tier == "business" else 10000
        )
        session.add(org)
        await session.flush()
        
        # Create admin user
        user_id = str(uuid.uuid4())
        user = User(
            id=user_id,
            organization_id=org_id,
            auth0_user_id=f"auth0|{uuid.uuid4().hex}",
            email=admin_email,
            full_name=admin_name,
            role=UserRole.ADMIN,
            is_active=True
        )
        session.add(user)
        await session.flush()
        
        # Create API key
        full_key, key_hash, key_prefix = generate_api_key()
        
        api_key = ApiKey(
            id=str(uuid.uuid4()),
            organization_id=org_id,
            name="Primary API Key",
            key_hash=key_hash,
            key_prefix=key_prefix,
            is_active=True,
            rate_limit_per_minute=60 if tier == "professional" else 100 if tier == "business" else 200
        )
        session.add(api_key)
        
        await session.commit()
        
        print("\nâœ… Organization created successfully!")
        print(f"\nðŸ“‹ Organization ID: {org_id}")
        print(f"ðŸ”‘ API Key: {full_key}")
        print(f"\nâš ï¸  Save this API key securely!")

async def main():
    """Main setup menu"""
    
    if len(sys.argv) > 1:
        if sys.argv[1] == "init":
            await setup_database()
        elif sys.argv[1] == "create-org":
            await create_organization_interactive()
        else:
            print(f"Unknown command: {sys.argv[1]}")
            print("Usage: python setup_database.py [init|create-org]")
    else:
        # Interactive mode
        print("\n1. Initialize database with demo organization")
        print("2. Create new organization")
        print("3. Exit")
        
        choice = input("\nSelect option (1-3): ")
        
        if choice == "1":
            await setup_database()
        elif choice == "2":
            await create_organization_interactive()
        elif choice == "3":
            print("Goodbye!")
            return
        else:
            print("Invalid choice")

if __name__ == "__main__":
    asyncio.run(main())

# ============================================================================
# docker-compose.yml - Updated with PostgreSQL
# ============================================================================

version: '3.8'

services:
  db:
    image: postgres:15-alpine
    environment:
      POSTGRES_DB: compliance_scraper
      POSTGRES_USER: scraper
      POSTGRES_PASSWORD: ${DB_PASSWORD:-secure_password_change_me}
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U scraper"]
      interval: 10s
      timeout: 5s
      retries: 5

  api:
    build: .
    depends_on:
      db:
        condition: service_healthy
    ports:
      - "8000:8000"
    environment:
      - DATABASE_URL=postgresql+asyncpg://scraper:${DB_PASSWORD:-secure_password_change_me}@db:5432/compliance_scraper
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    volumes:
      - ./chroma_db:/app/chroma_db
      - ./reports:/app/reports
    restart: unless-stopped
    command: >
      sh -c "
        python -m playwright install chromium &&
        python setup_database.py init &&
        uvicorn main:app --host 0.0.0.0 --port 8000
      "

volumes:
  postgres_data:

# ============================================================================
# Updated requirements.txt
# ============================================================================

fastapi==0.109.0
uvicorn==0.27.0
playwright==1.41.0
beautifulsoup4==4.12.3
langchain==0.1.0
langchain-openai==0.0.2
chromadb==0.4.22
pypdf==4.0.0
python-dotenv==1.0.0
pydantic==2.5.3
robotexclusionrulesparser==1.7.1
aiohttp==3.9.1
reportlab==4.0.9
python-multipart==0.0.6

# PostgreSQL dependencies
sqlalchemy==2.0.25
asyncpg==0.29.0
alembic==1.13.1
psycopg2-binary==2.9.9

# ============================================================================
# .env.example - Environment Variables Template
# ============================================================================

# Database
DATABASE_URL=postgresql+asyncpg://scraper:password@localhost:5432/compliance_scraper
DB_PASSWORD=secure_password_change_me

# OpenAI
OPENAI_API_KEY=sk-your-openai-key-here

# Optional: Anthropic (for Claude)
ANTHROPIC_API_KEY=sk-ant-your-key-here

# Application
ENVIRONMENT=development
LOG_LEVEL=INFO

# ============================================================================
# Quick Start Commands
# ============================================================================

# 1. Setup local database with Docker:
#    docker-compose up -d db

# 2. Install dependencies:
#    pip install -r requirements.txt
#    python -m playwright install chromium

# 3. Setup database:
#    python setup_database.py init

# 4. Run application:
#    uvicorn main:app --reload

# 5. Test with API key:
#    Use the API key from setup output

# ============================================================================
# Railway/Render Deployment
# ============================================================================

# Railway:
# 1. Create PostgreSQL database
# 2. Set DATABASE_URL environment variable
# 3. Deploy from GitHub
# 4. Run: python setup_database.py init

# Render:
# 1. Create PostgreSQL database
# 2. Create Web Service
# 3. Add DATABASE_URL from database
# 4. Build command: pip install -r requirements.txt && python -m playwright install chromium
# 5. Start command: python setup_database.py init && uvicorn main:app --host 0.0.0.0 --port $PORT